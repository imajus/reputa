# Oracle API Enhancement for AI Metadata

## ADDED Requirements

### Requirement: Extended API Response Format
The oracle API SHALL return AI-generated metadata alongside signed score data.

#### Scenario: Backward compatible response structure
- **WHEN** /score endpoint returns successfully
- **THEN** it SHALL include all existing fields: score, wallet_address, timestamp_ms, signature
- **AND** existing fields SHALL maintain same types and format
- **AND** signature SHALL cover only score, wallet_address, timestamp_ms (unchanged)
- **AND** clients not expecting metadata SHALL continue to work

#### Scenario: Metadata field addition
- **WHEN** /score response includes metadata
- **THEN** metadata SHALL be a JSON object
- **AND** metadata SHALL NOT be included in BCS serialization
- **AND** metadata SHALL NOT be included in signature
- **AND** metadata SHALL be optional for client consumption

#### Scenario: Reasoning field
- **WHEN** metadata object is present
- **THEN** it SHALL include reasoning field as string
- **AND** reasoning SHALL be 2-3 sentences explaining the score
- **AND** reasoning SHALL mention key factors (e.g., "Strong DeFi engagement across multiple protocols")
- **AND** reasoning SHALL be human-readable

#### Scenario: Risk factors field
- **WHEN** metadata object is present
- **THEN** it SHALL include risk_factors field as array of strings
- **AND** each risk factor SHALL be a short phrase (e.g., "Low recent activity")
- **AND** risk_factors MAY be empty array if no risks identified
- **AND** risk_factors SHALL be generated by AI analysis

#### Scenario: Strengths field
- **WHEN** metadata object is present
- **THEN** it SHALL include strengths field as array of strings
- **AND** each strength SHALL be a short phrase (e.g., "High protocol diversity")
- **AND** strengths MAY be empty array if no strengths identified
- **AND** strengths SHALL be generated by AI analysis

#### Scenario: Features field
- **WHEN** metadata object is present
- **THEN** it SHALL include features field as object
- **AND** features SHALL contain totalTransactions (number)
- **AND** features SHALL contain accountAgeDays (number)
- **AND** features SHALL contain recentActivity object with day, week, month counts
- **AND** features SHALL contain uniqueContracts (number)
- **AND** features SHALL contain protocolsUsed (array of strings)
- **AND** features SHALL contain valueStats object with total, average, count

### Requirement: Frontend Integration Compatibility
The API response SHALL remain compatible with existing frontend oracle-integration specification.

#### Scenario: Required fields preservation
- **WHEN** frontend fetches score from oracle
- **THEN** response SHALL include score field (number) as before
- **AND** response SHALL include signature field (string) as before
- **AND** response SHALL include walletAddress field (string) as before
- **AND** response SHALL include timestamp field (number) mapped from timestamp_ms
- **AND** all existing frontend code SHALL work without modification

#### Scenario: Optional metadata consumption
- **WHEN** frontend receives oracle response
- **THEN** it MAY check for metadata field presence
- **AND** it MAY display reasoning to user
- **AND** it MAY display risk_factors as warnings
- **AND** it MAY display strengths as highlights
- **AND** it SHALL NOT fail if metadata is absent (backward compatibility)

### Requirement: Environment Configuration
The application SHALL use environment variable for Ollama host configuration.

#### Scenario: OLLAMA_HOST variable
- **WHEN** docker-compose.yml is read
- **THEN** evm-score-oracle service SHALL set OLLAMA_HOST environment variable
- **AND** it SHALL be set to http://127.0.0.1:11434 for TEE deployment
- **AND** variable SHALL be accessible in Node.js via process.env.OLLAMA_HOST

#### Scenario: Ollama client configuration
- **WHEN** Ollama client is initialized
- **THEN** it SHALL read host from process.env.OLLAMA_HOST
- **AND** it SHALL default to http://127.0.0.1:11434 if not set
- **AND** it SHALL allow override for local testing

## MODIFIED Requirements

None - API response structure is extended, not modified (backward compatible)

## REMOVED Requirements

None
